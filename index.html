<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Services Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div id="root"></div>

<style>
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    .gradient-bg {
        background: linear-gradient(135deg, #1a365d 0%, #2563eb 100%);
    }
    
    /* Ensure full height for login screen */
    .min-h-screen {
        min-height: 100vh;
    }
    
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .entity-card {
        transition: all 0.2s ease;
    }
    
    .entity-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
</style>

<script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // Initialize Supabase client
    const supabaseUrl = 'https://cpddhpwzgkivzfkqlbop.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwZGRocHd6Z2tpdnpma3FsYm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjE0MzEsImV4cCI6MjA3MjQzNzQzMX0.DQPbGH8fCnCeg208XPlJStwCltpLc77DrRKUlDJE1V0';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Icon components
    const Icon = ({ type, className = "h-4 w-4" }) => {
        const icons = {
            plus: "➕",
            edit: "✏️",
            trash: "🗑️",
            x: "✖️",
            search: "🔍",
            sync: "🔄",
            logout: "🚪",
            lock: "🔒",
            building: "🏢",
            map: "📍",
            phone: "📞",
            calendar: "📅",
            truck: "🚛",
            alert: "⚠️",
            plane: "✈️",
            location: "📍",
            users: "👥",
            dispatch: "📢",
            globe: "🌐",
            tag: "🏷️"
        };
        return <span className={className}>{icons[type] || "❓"}</span>;
    };

    const EmergencyPortal = () => {
        const [activeTab, setActiveTab] = useState('entities');
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedEntity, setSelectedEntity] = useState(null);
        const [selectedPayor, setSelectedPayor] = useState(null);
        const [showAdmin, setShowAdmin] = useState(false);
        const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
        const [isPortalAuthenticated, setIsPortalAuthenticated] = useState(false);
        const [showAdminPasswordModal, setShowAdminPasswordModal] = useState(false);
        const [adminAction, setAdminAction] = useState('');
        const [entities, setEntities] = useState([]);
        const [payors, setPayors] = useState([]);
        const [loading, setLoading] = useState(true);
        const [payorsLoading, setPayorsLoading] = useState(true);
        const [lastSync, setLastSync] = useState(null);
        const [entityToEdit, setEntityToEdit] = useState(null);
        const [payorToEdit, setPayorToEdit] = useState(null);

        // Load entities from Supabase
        const loadEntities = useCallback(async () => {
            try {
                const { data, error } = await supabase
                    .from('emergency_entities')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error('Error loading entities:', error);
                    return;
                }

                const transformedEntities = data.map(entity => ({
                    id: entity.id,
                    name: entity.name,
                    type: entity.type,
                    address: entity.address,
                    phoneNumbers: entity.phone_numbers || [],
                    contractedService: entity.contracted_service || '',
                    contractualObligations: entity.contractual_obligations || [],
                    erEntrance: entity.er_entrance || '',
                    flightProgram: entity.flight_program ? { 
                        isOneCall: entity.flight_program.isOneCall || false,
                        participating: entity.flight_program.participating || false,
                        flightByGround: entity.flight_program.flightByGround || false,
                        notes: entity.flight_program.notes || '',
                        landingZones: entity.flight_program.landingZones || []
                    } : { 
                        isOneCall: false, 
                        participating: false, 
                        flightByGround: false, 
                        notes: '',
                        landingZones: []
                    },
                    backupServices: entity.backup_services ? {
                        airServices: entity.backup_services.airServices || [],
                        groundServices: entity.backup_services.groundServices || [],
                        noUnitsContact: entity.backup_services.noUnitsContact || '',
                        mutualAid: entity.backup_services.mutualAid || ''
                    } : {
                        airServices: [],
                        groundServices: [],
                        noUnitsContact: '',
                        mutualAid: ''
                    },
                    countyInfo: entity.county_info ? {
                        county: entity.county_info.county || '',
                        sheriffAgencies: entity.county_info.sheriffAgencies || [],
                        fireAgencies: entity.county_info.fireAgencies || [],
                        emsAgencies: entity.county_info.emsAgencies || []
                    } : {
                        county: '',
                        sheriffAgencies: [],
                        fireAgencies: [],
                        emsAgencies: []
                    },
                    notes: entity.notes || '',
                    lastContact: entity.last_contact || ''
                }));

                setEntities(transformedEntities);
                setLastSync(new Date().toLocaleTimeString());
            } catch (err) {
                console.error('Error loading entities:', err);
            } finally {
                setLoading(false);
            }
        }, []);

        // Load payors from Supabase
        const loadPayors = useCallback(async () => {
            try {
                const { data, error } = await supabase
                    .from('insurance_payors')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) {
                    console.log('Insurance payors table not yet created:', error.message);
                    setPayors([]);
                    return;
                }

                const transformedPayors = data.map(payor => ({
                    id: payor.id,
                    name: payor.name,
                    type: payor.type,
                    website: payor.website,
                    phoneNumbers: payor.phone_numbers || [],
                    emergencyGround: payor.emergency_ground || {},
                    nonEmergencyGround: payor.non_emergency_ground || {},
                    rotorWing: payor.rotor_wing || {},
                    fixedWing: payor.fixed_wing || {},
                    referenceLinks: payor.reference_links || [],
                    notes: payor.notes || ''
                }));

                setPayors(transformedPayors);
                setLastSync(new Date().toLocaleTimeString());
            } catch (err) {
                console.log('Payors not loaded yet:', err);
                setPayors([]);
            } finally {
                setPayorsLoading(false);
            }
        }, []);

        useEffect(() => {
            loadEntities();
            loadPayors();

            const entitiesSubscription = supabase
                .channel('emergency_entities_changes')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'emergency_entities' 
                }, payload => {
                    loadEntities();
                })
                .subscribe();

            const payorsSubscription = supabase
                .channel('insurance_payors_changes')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'insurance_payors' 
                }, payload => {
                    loadPayors();
                })
                .subscribe();

            return () => {
                entitiesSubscription.unsubscribe();
                payorsSubscription.unsubscribe();
            };
        }, [loadEntities, loadPayors]);

        // Password verification
        const handleAdminPasswordSubmit = (password) => {
            if (password === '04911') {
                setIsAdminAuthenticated(true);
                setShowAdminPasswordModal(false);
                if (adminAction === 'admin') {
                    setShowAdmin(true);
                }
            } else {
                alert('Incorrect password');
            }
        };

        const handlePortalPasswordSubmit = (password) => {
            if (password === 'dispatch2024') {
                setIsPortalAuthenticated(true);
            } else {
                alert('Incorrect password');
            }
        };

        // Entity management functions
        const handleSaveNewEntity = async (formData) => {
            try {
                const today = new Date().toISOString().split('T')[0];
                const entityToSave = {
                    name: formData.name,
                    type: formData.type,
                    address: formData.address,
                    phone_numbers: formData.phone_numbers,
                    contracted_service: formData.contracted_service,
                    contractual_obligations: formData.contractual_obligations,
                    er_entrance: formData.er_entrance,
                    flight_program: formData.flight_program,
                    backup_services: formData.backup_services,
                    county_info: formData.county_info,
                    notes: formData.notes,
                    last_contact: formData.last_contact || today
                };

                if (formData.id) {
                    const { data, error } = await supabase
                        .from('emergency_entities')
                        .update(entityToSave)
                        .eq('id', formData.id)
                        .select();

                    if (error) {
                        console.error('Error updating entity:', error);
                        alert('Error updating entity. Please try again.');
                        return;
                    }
                    setEntityToEdit(null);
                } else {
                    const { data, error } = await supabase
                        .from('emergency_entities')
                        .insert([entityToSave])
                        .select();

                    if (error) {
                        console.error('Error saving entity:', error);
                        alert('Error saving entity. Please try again.');
                        return;
                    }
                }

                setShowAdmin(false);
            } catch (err) {
                console.error('Error saving entity:', err);
                alert('Error saving entity. Please try again.');
            }
        };

        // NEW: Insurance Payor management functions
        const handleSaveNewPayor = async (formData) => {
            try {
                const payorToSave = {
                    name: formData.name,
                    type: formData.type,
                    website: formData.website,
                    phone_numbers: formData.phone_numbers,
                    emergency_ground: formData.emergency_ground,
                    non_emergency_ground: formData.non_emergency_ground,
                    rotor_wing: formData.rotor_wing,
                    fixed_wing: formData.fixed_wing,
                    reference_links: formData.reference_links,
                    notes: formData.notes
                };

                if (formData.id) {
                    const { data, error } = await supabase
                        .from('insurance_payors')
                        .update(payorToSave)
                        .eq('id', formData.id)
                        .select();

                    if (error) {
                        console.error('Error updating payor:', error);
                        alert('Error updating payor. Please try again.');
                        return;
                    }
                    setPayorToEdit(null);
                } else {
                    const { data, error } = await supabase
                        .from('insurance_payors')
                        .insert([payorToSave])
                        .select();

                    if (error) {
                        console.error('Error saving payor:', error);
                        alert('Error saving payor. Please try again.');
                        return;
                    }
                }

                setShowAdmin(false);
            } catch (err) {
                console.error('Error saving payor:', err);
                alert('Error saving payor. Please try again.');
            }
        };

        const handleDeleteEntity = async (entityId) => {
            if (confirm('Are you sure you want to delete this entity?')) {
                try {
                    const { error } = await supabase
                        .from('emergency_entities')
                        .delete()
                        .eq('id', entityId);

                    if (error) {
                        console.error('Error deleting entity:', error);
                        alert('Error deleting entity. Please try again.');
                        return;
                    }

                    setSelectedEntity(null);
                } catch (err) {
                    console.error('Error deleting entity:', err);
                    alert('Error deleting entity. Please try again.');
                }
            }
        };

        const handleDeletePayor = async (payorId) => {
            if (confirm('Are you sure you want to delete this payor?')) {
                try {
                    const { error } = await supabase
                        .from('insurance_payors')
                        .delete()
                        .eq('id', payorId);

                    if (error) {
                        console.error('Error deleting payor:', error);
                        alert('Error deleting payor. Please try again.');
                        return;
                    }

                    setSelectedPayor(null);
                } catch (err) {
                    console.error('Error deleting payor:', err);
                    alert('Error deleting payor. Please try again.');
                }
            }
        };

        const handleEditEntity = (entity) => {
            console.log('Editing entity:', entity);
            setEntityToEdit(entity);
            setShowAdmin(true);
        };

        const handleEditPayor = (payor) => {
            setPayorToEdit(payor);
            setShowAdmin(true);
        };

        const filteredEntities = entities.filter(entity =>
            entity.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            entity.address.toLowerCase().includes(searchTerm.toLowerCase()) ||
            entity.type.toLowerCase().includes(searchTerm.toLowerCase())
        );

        const filteredPayors = payors.filter(payor =>
            payor.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            payor.type.toLowerCase().includes(searchTerm.toLowerCase())
        );

        const groupedEntities = useMemo(() => {
            const groups = {};
            filteredEntities.forEach(entity => {
                if (!groups[entity.type]) {
                    groups[entity.type] = [];
                }
                groups[entity.type].push(entity);
            });
            return groups;
        }, [filteredEntities]);

        // Password Modal Component
        const PasswordModal = ({ isOpen, onClose, onSubmit, title, message }) => {
            const [password, setPassword] = useState('');
            
            if (!isOpen) return null;
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(password);
                setPassword('');
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="text-xl font-medium text-gray-900 flex items-center">
                                <Icon type="lock" className="mr-2" />
                                {title}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-500">
                                <Icon type="x" />
                            </button>
                        </div>
                        <p className="mb-4 text-gray-600">{message}</p>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input
                                    type="password"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            <div className="flex justify-end">
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                                >
                                    Submit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Entity Form Component
        const EntityForm = ({ entity, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                id: entity?.id || null,
                name: entity?.name || '',
                type: entity?.type || 'hospital',
                address: entity?.address || '',
                phone_numbers: entity?.phoneNumbers && entity.phoneNumbers.length > 0 
                    ? entity.phoneNumbers 
                    : [{ label: '', number: '', description: '' }],
                contracted_service: entity?.contractedService || '',
                contractual_obligations: entity?.contractualObligations && entity.contractualObligations.length > 0 
                    ? entity.contractualObligations 
                    : [''],
                er_entrance: entity?.erEntrance || '',
                flight_program: entity?.flightProgram ? {
                    isOneCall: entity.flightProgram.isOneCall || false,
                    participating: entity.flightProgram.participating || false,
                    flightByGround: entity.flightProgram.flightByGround || false,
                    notes: entity.flightProgram.notes || '',
                    landingZones: entity.flightProgram.landingZones && entity.flightProgram.landingZones.length > 0 
                        ? entity.flightProgram.landingZones 
                        : [{ name: '', coordinates: '', description: '' }]
                } : { 
                    isOneCall: false, 
                    participating: false, 
                    flightByGround: false, 
                    notes: '',
                    landingZones: [{ name: '', coordinates: '', description: '' }]
                },
                backup_services: entity?.backupServices ? {
                    airServices: entity.backupServices.airServices && entity.backupServices.airServices.length > 0 
                        ? entity.backupServices.airServices 
                        : [{ name: '', phone: '', description: '' }],
                    groundServices: entity.backupServices.groundServices && entity.backupServices.groundServices.length > 0 
                        ? entity.backupServices.groundServices 
                        : [{ name: '', phone: '', description: '' }],
                    noUnitsContact: entity.backupServices.noUnitsContact || '',
                    mutualAid: entity.backupServices.mutualAid || ''
                } : {
                    airServices: [{ name: '', phone: '', description: '' }],
                    groundServices: [{ name: '', phone: '', description: '' }],
                    noUnitsContact: '',
                    mutualAid: ''
                },
                county_info: entity?.countyInfo ? {
                    county: entity.countyInfo.county || '',
                    sheriffAgencies: entity.countyInfo.sheriffAgencies && entity.countyInfo.sheriffAgencies.length > 0 
                        ? entity.countyInfo.sheriffAgencies 
                        : [{ name: '', phone: '', description: '' }],
                    fireAgencies: entity.countyInfo.fireAgencies && entity.countyInfo.fireAgencies.length > 0 
                        ? entity.countyInfo.fireAgencies 
                        : [{ name: '', phone: '', description: '' }],
                    emsAgencies: entity.countyInfo.emsAgencies && entity.countyInfo.emsAgencies.length > 0 
                        ? entity.countyInfo.emsAgencies 
                        : [{ name: '', phone: '', description: '' }]
                } : {
                    county: '',
                    sheriffAgencies: [{ name: '', phone: '', description: '' }],
                    fireAgencies: [{ name: '', phone: '', description: '' }],
                    emsAgencies: [{ name: '', phone: '', description: '' }]
                },
                notes: entity?.notes || '',
                last_contact: entity?.lastContact || ''
            });

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handlePhoneChange = (index, field, value) => {
                const newPhones = [...formData.phone_numbers];
                newPhones[index] = { ...newPhones[index], [field]: value };
                setFormData(prev => ({ ...prev, phone_numbers: newPhones }));
            };

            const addPhoneField = () => {
                setFormData(prev => ({
                    ...prev,
                    phone_numbers: [...prev.phone_numbers, { label: '', number: '', description: '' }]
                }));
            };

            const removePhoneField = (index) => {
                if (formData.phone_numbers.length <= 1) return;
                const newPhones = [...formData.phone_numbers];
                newPhones.splice(index, 1);
                setFormData(prev => ({ ...prev, phone_numbers: newPhones }));
            };

            const handleFlightProgramChange = (field, value) => {
                setFormData(prev => ({
                    ...prev,
                    flight_program: { ...prev.flight_program, [field]: value }
                }));
            };

            const handleLandingZoneChange = (index, field, value) => {
                const newLandingZones = [...formData.flight_program.landingZones];
                newLandingZones[index] = { ...newLandingZones[index], [field]: value };
                setFormData(prev => ({
                    ...prev,
                    flight_program: { ...prev.flight_program, landingZones: newLandingZones }
                }));
            };

            const addLandingZone = () => {
                setFormData(prev => ({
                    ...prev,
                    flight_program: {
                        ...prev.flight_program,
                        landingZones: [...prev.flight_program.landingZones, { name: '', coordinates: '', description: '' }]
                    }
                }));
            };

            const removeLandingZone = (index) => {
                const newLandingZones = [...formData.flight_program.landingZones];
                newLandingZones.splice(index, 1);
                setFormData(prev => ({
                    ...prev,
                    flight_program: { ...prev.flight_program, landingZones: newLandingZones }
                }));
            };

            const handleBackupServiceChange = (serviceType, index, field, value) => {
                const newServices = [...formData.backup_services[serviceType]];
                newServices[index] = { ...newServices[index], [field]: value };
                setFormData(prev => ({
                    ...prev,
                    backup_services: { ...prev.backup_services, [serviceType]: newServices }
                }));
            };

            const addBackupService = (serviceType) => {
                setFormData(prev => ({
                    ...prev,
                    backup_services: {
                        ...prev.backup_services,
                        [serviceType]: [...prev.backup_services[serviceType], { name: '', phone: '', description: '' }]
                    }
                }));
            };

            const removeBackupService = (serviceType, index) => {
                const newServices = [...formData.backup_services[serviceType]];
                newServices.splice(index, 1);
                setFormData(prev => ({
                    ...prev,
                    backup_services: { ...prev.backup_services, [serviceType]: newServices }
                }));
            };

            const handleAgencyChange = (agencyType, index, field, value) => {
                const newAgencies = [...formData.county_info[agencyType]];
                newAgencies[index] = { ...newAgencies[index], [field]: value };
                setFormData(prev => ({
                    ...prev,
                    county_info: { ...prev.county_info, [agencyType]: newAgencies }
                }));
            };

            const addAgency = (agencyType) => {
                setFormData(prev => ({
                    ...prev,
                    county_info: {
                        ...prev.county_info,
                        [agencyType]: [...prev.county_info[agencyType], { name: '', phone: '', description: '' }]
                    }
                }));
            };

            const removeAgency = (agencyType, index) => {
                const newAgencies = [...formData.county_info[agencyType]];
                newAgencies.splice(index, 1);
                setFormData(prev => ({
                    ...prev,
                    county_info: { ...prev.county_info, [agencyType]: newAgencies }
                }));
            };

            const handleContractualObligationChange = (index, value) => {
                const newObligations = [...formData.contractual_obligations];
                newObligations[index] = value;
                setFormData(prev => ({ ...prev, contractual_obligations: newObligations }));
            };

            const addContractualObligation = () => {
                setFormData(prev => ({
                    ...prev,
                    contractual_obligations: [...prev.contractual_obligations, '']
                }));
            };

            const removeContractualObligation = (index) => {
                if (formData.contractual_obligations.length <= 1) return;
                const newObligations = [...formData.contractual_obligations];
                newObligations.splice(index, 1);
                setFormData(prev => ({ ...prev, contractual_obligations: newObligations }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-900">
                            {entity ? 'Edit Entity' : 'Add New Entity'}
                        </h2>
                        <button
                            onClick={onCancel}
                            className="p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-200"
                        >
                            <Icon type="x" />
                        </button>
                    </div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                        {/* Basic Information */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Basic Information</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                    <input
                                        type="text"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.name}
                                        onChange={(e) => handleChange('name', e.target.value)}
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.type}
                                        onChange={(e) => handleChange('type', e.target.value)}
                                    >
                                        <option value="hospital">Hospital</option>
                                        <option value="fire_station">Fire Station</option>
                                        <option value="911_center">911 Center</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                    <input
                                        type="text"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.address}
                                        onChange={(e) => handleChange('address', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Phone Numbers */}
                        <div>
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-medium text-gray-900 text-lg border-b pb-2">Phone Numbers</h3>
                                <button
                                    type="button"
                                    onClick={addPhoneField}
                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center"
                                >
                                    <Icon type="plus" className="mr-1" /> Add
                                </button>
                            </div>
                            <div className="space-y-3">
                                {formData.phone_numbers.map((phone, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                        <div className="md:col-span-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.label}
                                                onChange={(e) => handlePhoneChange(index, 'label', e.target.value)}
                                                placeholder="e.g., Main, Fax, Emergency"
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Number</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.number}
                                                onChange={(e) => handlePhoneChange(index, 'number', e.target.value)}
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.description}
                                                onChange={(e) => handlePhoneChange(index, 'description', e.target.value)}
                                            />
                                        </div>
                                        <div className="md:col-span-1">
                                            {formData.phone_numbers.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removePhoneField(index)}
                                                    className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                >
                                                    <Icon type="trash" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Contracted Service */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Contracted Service</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Primary Contracted Service</label>
                                    <input
                                        type="text"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.contracted_service}
                                        onChange={(e) => handleChange('contracted_service', e.target.value)}
                                        placeholder="e.g., AirMed, STAT Med, etc."
                                    />
                                </div>
                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-medium text-gray-700">Contractual Obligations</label>
                                        <button
                                            type="button"
                                            onClick={addContractualObligation}
                                            className="px-2 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors text-sm flex items-center"
                                        >
                                            <Icon type="plus" className="mr-1" /> Add
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        {formData.contractual_obligations.map((obligation, index) => (
                                            <div key={index} className="flex items-center space-x-2">
                                                <input
                                                    type="text"
                                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={obligation}
                                                    onChange={(e) => handleContractualObligationChange(index, e.target.value)}
                                                    placeholder="Contractual obligation details"
                                                />
                                                {formData.contractual_obligations.length > 1 && (
                                                    <button
                                                        type="button"
                                                        onClick={() => removeContractualObligation(index)}
                                                        className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors"
                                                    >
                                                        <Icon type="trash" />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* ER Entrance */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">ER Entrance</h3>
                            <textarea
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={formData.er_entrance}
                                onChange={(e) => handleChange('er_entrance', e.target.value)}
                                placeholder="Directions to ER entrance, special instructions, etc."
                            />
                        </div>

                        {/* Flight Program */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Flight Program</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="isOneCall"
                                        className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                        checked={formData.flight_program.isOneCall}
                                        onChange={(e) => handleFlightProgramChange('isOneCall', e.target.checked)}
                                    />
                                    <label htmlFor="isOneCall" className="ml-2 block text-sm text-gray-900">
                                        One Call
                                    </label>
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="participating"
                                        className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                        checked={formData.flight_program.participating}
                                        onChange={(e) => handleFlightProgramChange('participating', e.target.checked)}
                                    />
                                    <label htmlFor="participating" className="ml-2 block text-sm text-gray-900">
                                        Participating
                                    </label>
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        id="flightByGround"
                                        className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                        checked={formData.flight_program.flightByGround}
                                        onChange={(e) => handleFlightProgramChange('flightByGround', e.target.checked)}
                                    />
                                    <label htmlFor="flightByGround" className="ml-2 block text-sm text-gray-900">
                                        Flight By Ground
                                    </label>
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                <textarea
                                    rows="3"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={formData.flight_program.notes}
                                    onChange={(e) => handleFlightProgramChange('notes', e.target.value)}
                                    placeholder="Special flight program notes or instructions"
                                />
                            </div>
                            
                            {/* Landing Zones for 911 Centers */}
                            {formData.type === '911_center' && (
                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-medium text-gray-900">Known Landing Zones</h4>
                                        <button
                                            type="button"
                                            onClick={addLandingZone}
                                            className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                        >
                                            <Icon type="plus" className="mr-1" /> Add
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {formData.flight_program.landingZones.map((zone, index) => (
                                            <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Zone Name</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={zone.name}
                                                        onChange={(e) => handleLandingZoneChange(index, 'name', e.target.value)}
                                                        placeholder="e.g., Downtown LZ, Park LZ"
                                                    />
                                                </div>
                                                <div className="md:col-span-3">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Coordinates</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={zone.coordinates}
                                                        onChange={(e) => handleLandingZoneChange(index, 'coordinates', e.target.value)}
                                                        placeholder="e.g., 34.0522,-118.2437"
                                                    />
                                                </div>
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={zone.description}
                                                        onChange={(e) => handleLandingZoneChange(index, 'description', e.target.value)}
                                                        placeholder="Special instructions or notes"
                                                    />
                                                </div>
                                                <div className="md:col-span-1">
                                                    {formData.flight_program.landingZones.length > 1 && (
                                                        <button
                                                            type="button"
                                                            onClick={() => removeLandingZone(index)}
                                                            className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                        >
                                                            <Icon type="trash" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Backup Services */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Backup Services</h3>
                            <div className="space-y-6">
                                {/* Air Services */}
                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-medium text-gray-900">Air Services</h4>
                                        <button
                                            type="button"
                                            onClick={() => addBackupService('airServices')}
                                            className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                        >
                                            <Icon type="plus" className="mr-1" /> Add
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {formData.backup_services.airServices.map((service, index) => (
                                            <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Service Name</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.name}
                                                        onChange={(e) => handleBackupServiceChange('airServices', index, 'name', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-3">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.phone}
                                                        onChange={(e) => handleBackupServiceChange('airServices', index, 'phone', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.description}
                                                        onChange={(e) => handleBackupServiceChange('airServices', index, 'description', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-1">
                                                    {formData.backup_services.airServices.length > 1 && (
                                                        <button
                                                            type="button"
                                                            onClick={() => removeBackupService('airServices', index)}
                                                            className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                        >
                                                            <Icon type="trash" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Ground Services */}
                                <div>
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-medium text-gray-900">Ground Services</h4>
                                        <button
                                            type="button"
                                            onClick={() => addBackupService('groundServices')}
                                            className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                        >
                                            <Icon type="plus" className="mr-1" /> Add
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {formData.backup_services.groundServices.map((service, index) => (
                                            <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Service Name</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.name}
                                                        onChange={(e) => handleBackupServiceChange('groundServices', index, 'name', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-3">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.phone}
                                                        onChange={(e) => handleBackupServiceChange('groundServices', index, 'phone', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={service.description}
                                                        onChange={(e) => handleBackupServiceChange('groundServices', index, 'description', e.target.value)}
                                                    />
                                                </div>
                                                <div className="md:col-span-1">
                                                    {formData.backup_services.groundServices.length > 1 && (
                                                        <button
                                                            type="button"
                                                            onClick={() => removeBackupService('groundServices', index)}
                                                            className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                        >
                                                            <Icon type="trash" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">No Units Contact Protocol</label>
                                        <textarea
                                            rows="2"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value={formData.backup_services.noUnitsContact}
                                            onChange={(e) => setFormData(prev => ({
                                                ...prev,
                                                backup_services: { ...prev.backup_services, noUnitsContact: e.target.value }
                                            }))}
                                            placeholder="Instructions when no units are available"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Mutual Aid Agreements</label>
                                        <textarea
                                            rows="2"
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            value={formData.backup_services.mutualAid}
                                            onChange={(e) => setFormData(prev => ({
                                                ...prev,
                                                backup_services: { ...prev.backup_services, mutualAid: e.target.value }
                                            }))}
                                            placeholder="Details about mutual aid agreements"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* County Information */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">County Information</h3>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">County</label>
                                <input
                                    type="text"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={formData.county_info.county}
                                    onChange={(e) => setFormData(prev => ({
                                        ...prev,
                                        county_info: { ...prev.county_info, county: e.target.value }
                                    }))}
                                    placeholder="County name"
                                />
                            </div>
                            
                            {/* Sheriff Agencies */}
                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-medium text-gray-900">Sheriff Agencies</h4>
                                    <button
                                        type="button"
                                        onClick={() => addAgency('sheriffAgencies')}
                                        className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                    >
                                        <Icon type="plus" className="mr-1" /> Add
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {formData.county_info.sheriffAgencies.map((agency, index) => (
                                        <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Agency Name</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.name}
                                                    onChange={(e) => handleAgencyChange('sheriffAgencies', index, 'name', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.phone}
                                                    onChange={(e) => handleAgencyChange('sheriffAgencies', index, 'phone', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.description}
                                                    onChange={(e) => handleAgencyChange('sheriffAgencies', index, 'description', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-1">
                                                {formData.county_info.sheriffAgencies.length > 1 && (
                                                    <button
                                                        type="button"
                                                        onClick={() => removeAgency('sheriffAgencies', index)}
                                                        className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                    >
                                                        <Icon type="trash" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Fire Agencies */}
                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-medium text-gray-900">Fire Agencies</h4>
                                    <button
                                        type="button"
                                        onClick={() => addAgency('fireAgencies')}
                                        className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                    >
                                        <Icon type="plus" className="mr-1" /> Add
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {formData.county_info.fireAgencies.map((agency, index) => (
                                        <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Agency Name</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.name}
                                                    onChange={(e) => handleAgencyChange('fireAgencies', index, 'name', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.phone}
                                                    onChange={(e) => handleAgencyChange('fireAgencies', index, 'phone', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.description}
                                                    onChange={(e) => handleAgencyChange('fireAgencies', index, 'description', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-1">
                                                {formData.county_info.fireAgencies.length > 1 && (
                                                    <button
                                                        type="button"
                                                        onClick={() => removeAgency('fireAgencies', index)}
                                                        className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                    >
                                                        <Icon type="trash" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* EMS Agencies */}
                            <div className="mb-4">
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-medium text-gray-900">EMS Agencies</h4>
                                    <button
                                        type="button"
                                        onClick={() => addAgency('emsAgencies')}
                                        className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                    >
                                        <Icon type="plus" className="mr-1" /> Add
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {formData.county_info.emsAgencies.map((agency, index) => (
                                        <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Agency Name</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.name}
                                                    onChange={(e) => handleAgencyChange('emsAgencies', index, 'name', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.phone}
                                                    onChange={(e) => handleAgencyChange('emsAgencies', index, 'phone', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                <input
                                                    type="text"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    value={agency.description}
                                                    onChange={(e) => handleAgencyChange('emsAgencies', index, 'description', e.target.value)}
                                                />
                                            </div>
                                            <div className="md:col-span-1">
                                                {formData.county_info.emsAgencies.length > 1 && (
                                                    <button
                                                        type="button"
                                                        onClick={() => removeAgency('emsAgencies', index)}
                                                        className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                    >
                                                        <Icon type="trash" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Notes */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Additional Notes</h3>
                            <textarea
                                rows="4"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={formData.notes}
                                onChange={(e) => handleChange('notes', e.target.value)}
                                placeholder="Any additional notes or information about this entity"
                            />
                        </div>

                        {/* Last Contact */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Last Contact Date</label>
                            <input
                                type="date"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={formData.last_contact}
                                onChange={(e) => handleChange('last_contact', e.target.value)}
                            />
                        </div>

                        {/* Form Actions */}
                        <div className="flex justify-end space-x-3 pt-4 border-t">
                            <button
                                type="button"
                                onClick={onCancel}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                            >
                                {entity ? 'Update Entity' : 'Add Entity'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // Payor Form Component
        const PayorForm = ({ payor, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                id: payor?.id || null,
                name: payor?.name || '',
                type: payor?.type || 'insurance',
                website: payor?.website || '',
                phone_numbers: payor?.phoneNumbers || [{ label: '', number: '', description: '' }],
                emergency_ground: payor?.emergencyGround || { phone: '', preauth_required: false, notes: '' },
                non_emergency_ground: payor?.nonEmergencyGround || { phone: '', preauth_required: false, notes: '' },
                rotor_wing: payor?.rotorWing || { phone: '', preauth_required: false, notes: '' },
                fixed_wing: payor?.fixedWing || { phone: '', preauth_required: false, notes: '' },
                reference_links: payor?.referenceLinks || [{ title: '', url: '', description: '' }],
                notes: payor?.notes || ''
            });

            const handleChange = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            const handlePhoneChange = (index, field, value) => {
                const newPhones = [...formData.phone_numbers];
                newPhones[index] = { ...newPhones[index], [field]: value };
                setFormData(prev => ({ ...prev, phone_numbers: newPhones }));
            };

            const addPhoneField = () => {
                setFormData(prev => ({
                    ...prev,
                    phone_numbers: [...prev.phone_numbers, { label: '', number: '', description: '' }]
                }));
            };

            const removePhoneField = (index) => {
                if (formData.phone_numbers.length <= 1) return;
                const newPhones = [...formData.phone_numbers];
                newPhones.splice(index, 1);
                setFormData(prev => ({ ...prev, phone_numbers: newPhones }));
            };

            const handleServiceChange = (serviceType, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    [serviceType]: { ...prev[serviceType], [field]: value }
                }));
            };

            const handleReferenceLinkChange = (index, field, value) => {
                const newLinks = [...formData.reference_links];
                newLinks[index] = { ...newLinks[index], [field]: value };
                setFormData(prev => ({ ...prev, reference_links: newLinks }));
            };

            const addReferenceLink = () => {
                setFormData(prev => ({
                    ...prev,
                    reference_links: [...prev.reference_links, { title: '', url: '', description: '' }]
                }));
            };

            const removeReferenceLink = (index) => {
                if (formData.reference_links.length <= 1) return;
                const newLinks = [...formData.reference_links];
                newLinks.splice(index, 1);
                setFormData(prev => ({ ...prev, reference_links: newLinks }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-900">
                            {payor ? 'Edit Payor' : 'Add New Payor'}
                        </h2>
                        <button
                            onClick={onCancel}
                            className="p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-200"
                        >
                            <Icon type="x" />
                        </button>
                    </div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                        {/* Basic Information */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Basic Information</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                    <input
                                        type="text"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.name}
                                        onChange={(e) => handleChange('name', e.target.value)}
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.type}
                                        onChange={(e) => handleChange('type', e.target.value)}
                                    >
                                        <option value="insurance">Insurance</option>
                                        <option value="government">Government</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Website</label>
                                    <input
                                        type="url"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={formData.website}
                                        onChange={(e) => handleChange('website', e.target.value)}
                                        placeholder="https://example.com"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Phone Numbers */}
                        <div>
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-medium text-gray-900 text-lg border-b pb-2">Phone Numbers</h3>
                                <button
                                    type="button"
                                    onClick={addPhoneField}
                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center"
                                >
                                    <Icon type="plus" className="mr-1" /> Add
                                </button>
                            </div>
                            <div className="space-y-3">
                                {formData.phone_numbers.map((phone, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                        <div className="md:col-span-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.label}
                                                onChange={(e) => handlePhoneChange(index, 'label', e.target.value)}
                                                placeholder="e.g., Main, Claims, Authorization"
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Number</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.number}
                                                onChange={(e) => handlePhoneChange(index, 'number', e.target.value)}
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={phone.description}
                                                onChange={(e) => handlePhoneChange(index, 'description', e.target.value)}
                                            />
                                        </div>
                                        <div className="md:col-span-1">
                                            {formData.phone_numbers.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removePhoneField(index)}
                                                    className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                >
                                                    <Icon type="trash" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Service Categories */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Service Categories</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Emergency Ground */}
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <h4 className="font-medium text-gray-900 mb-3">Emergency Ground</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.emergency_ground.phone}
                                                onChange={(e) => handleServiceChange('emergency_ground', 'phone', e.target.value)}
                                            />
                                        </div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="emergencyGroundPreauth"
                                                className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                                checked={formData.emergency_ground.preauth_required}
                                                onChange={(e) => handleServiceChange('emergency_ground', 'preauth_required', e.target.checked)}
                                            />
                                            <label htmlFor="emergencyGroundPreauth" className="ml-2 block text-sm text-gray-900">
                                                Pre-authorization required
                                            </label>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                            <textarea
                                                rows="2"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.emergency_ground.notes}
                                                onChange={(e) => handleServiceChange('emergency_ground', 'notes', e.target.value)}
                                                placeholder="Special instructions or notes"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Non-Emergency Ground */}
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <h4 className="font-medium text-gray-900 mb-3">Non-Emergency Ground</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.non_emergency_ground.phone}
                                                onChange={(e) => handleServiceChange('non_emergency_ground', 'phone', e.target.value)}
                                            />
                                        </div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="nonEmergencyGroundPreauth"
                                                className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                                checked={formData.non_emergency_ground.preauth_required}
                                                onChange={(e) => handleServiceChange('non_emergency_ground', 'preauth_required', e.target.checked)}
                                            />
                                            <label htmlFor="nonEmergencyGroundPreauth" className="ml-2 block text-sm text-gray-900">
                                                Pre-authorization required
                                            </label>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                            <textarea
                                                rows="2"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.non_emergency_ground.notes}
                                                onChange={(e) => handleServiceChange('non_emergency_ground', 'notes', e.target.value)}
                                                placeholder="Special instructions or notes"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Rotor Wing */}
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <h4 className="font-medium text-gray-900 mb-3">Rotor Wing</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.rotor_wing.phone}
                                                onChange={(e) => handleServiceChange('rotor_wing', 'phone', e.target.value)}
                                            />
                                        </div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="rotorWingPreauth"
                                                className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                                checked={formData.rotor_wing.preauth_required}
                                                onChange={(e) => handleServiceChange('rotor_wing', 'preauth_required', e.target.checked)}
                                            />
                                            <label htmlFor="rotorWingPreauth" className="ml-2 block text-sm text-gray-900">
                                                Pre-authorization required
                                            </label>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                            <textarea
                                                rows="2"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.rotor_wing.notes}
                                                onChange={(e) => handleServiceChange('rotor_wing', 'notes', e.target.value)}
                                                placeholder="Special instructions or notes"
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Fixed Wing */}
                                <div className="bg-gray-50 p-4 rounded-md">
                                    <h4 className="font-medium text-gray-900 mb-3">Fixed Wing</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.fixed_wing.phone}
                                                onChange={(e) => handleServiceChange('fixed_wing', 'phone', e.target.value)}
                                            />
                                        </div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                id="fixedWingPreauth"
                                                className="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                                checked={formData.fixed_wing.preauth_required}
                                                onChange={(e) => handleServiceChange('fixed_wing', 'preauth_required', e.target.checked)}
                                            />
                                            <label htmlFor="fixedWingPreauth" className="ml-2 block text-sm text-gray-900">
                                                Pre-authorization required
                                            </label>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                                            <textarea
                                                rows="2"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={formData.fixed_wing.notes}
                                                onChange={(e) => handleServiceChange('fixed_wing', 'notes', e.target.value)}
                                                placeholder="Special instructions or notes"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Reference Links */}
                        <div>
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-medium text-gray-900 text-lg border-b pb-2">Reference Links</h3>
                                <button
                                    type="button"
                                    onClick={addReferenceLink}
                                    className="px-3 py-1 bg-blue-100 text-blue-600 rounded-md hover:bg-blue-200 transition-colors flex items-center text-sm"
                                >
                                    <Icon type="plus" className="mr-1" /> Add
                                </button>
                            </div>
                            <div className="space-y-3">
                                {formData.reference_links.map((link, index) => (
                                    <div key={index} className="grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded-md">
                                        <div className="md:col-span-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={link.title}
                                                onChange={(e) => handleReferenceLinkChange(index, 'title', e.target.value)}
                                                placeholder="e.g., Authorization Form, Coverage Policy"
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">URL</label>
                                            <input
                                                type="url"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={link.url}
                                                onChange={(e) => handleReferenceLinkChange(index, 'url', e.target.value)}
                                                placeholder="https://example.com/document"
                                            />
                                        </div>
                                        <div className="md:col-span-4">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                            <input
                                                type="text"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                value={link.description}
                                                onChange={(e) => handleReferenceLinkChange(index, 'description', e.target.value)}
                                                placeholder="Brief description of the document"
                                            />
                                        </div>
                                        <div className="md:col-span-1">
                                            {formData.reference_links.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => removeReferenceLink(index)}
                                                    className="px-2 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors w-full"
                                                >
                                                    <Icon type="trash" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Notes */}
                        <div>
                            <h3 className="font-medium text-gray-900 mb-3 text-lg border-b pb-2">Additional Notes</h3>
                            <textarea
                                rows="4"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={formData.notes}
                                onChange={(e) => handleChange('notes', e.target.value)}
                                placeholder="Any additional notes or information about this payor"
                            />
                        </div>

                        {/* Form Actions */}
                        <div className="flex justify-end space-x-3 pt-4 border-t">
                            <button
                                type="button"
                                onClick={onCancel}
                                className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                            >
                                {payor ? 'Update Payor' : 'Add Payor'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // If not authenticated to the portal, show login screen
        if (!isPortalAuthenticated) {
            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 mb-2">Emergency Services Portal</h1>
                            <p className="text-gray-600">Please enter your password to access the portal</p>
                        </div>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            handlePortalPasswordSubmit(document.getElementById('portalPassword').value);
                        }}>
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <Icon type="lock" />
                                    </div>
                                    <input
                                        type="password"
                                        id="portalPassword"
                                        className="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                            </div>
                            <button
                                type="submit"
                                className="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-medium"
                            >
                                Access Portal
                            </button>
                        </form>
                        <div className="mt-6 text-center text-sm text-gray-500">
                            <p>© 2025 Emergency Services Portal. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen bg-gray-50">
                {/* Header */}
                <header className="bg-white shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-gray-900">Emergency Services Portal</h1>
                        <div className="flex items-center space-x-4">
                            {lastSync && (
                                <div className="text-sm text-gray-500 flex items-center">
                                    <Icon type="sync" className="mr-1" />
                                    Last sync: {lastSync}
                                </div>
                            )}
                            <button
                                className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center"
                                onClick={() => {
                                    if (isAdminAuthenticated) {
                                        setShowAdmin(true);
                                    } else {
                                        setAdminAction('admin');
                                        setShowAdminPasswordModal(true);
                                    }
                                }}
                            >
                                <Icon type="plus" className="mr-1" />
                                Add {activeTab === 'entities' ? 'Entity' : 'Payor'}
                            </button>
                            <button
                                className="px-3 py-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors flex items-center"
                                onClick={() => setIsPortalAuthenticated(false)}
                            >
                                <Icon type="logout" className="mr-1" />
                                Logout
                            </button>
                        </div>
                    </div>

                    {/* Tab Navigation */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="border-b border-gray-200">
                            <nav className="flex space-x-8" aria-label="Tabs">
                                <button
                                    onClick={() => {
                                        setActiveTab('entities');
                                        setSelectedEntity(null);
                                        setSelectedPayor(null);
                                        setSearchTerm('');
                                    }}
                                    className={`whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm ${
                                        activeTab === 'entities'
                                            ? 'border-blue-500 text-blue-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    Customer/Call Source ({entities.length})
                                </button>
                                <button
                                    onClick={() => {
                                        setActiveTab('insurance');
                                        setSelectedEntity(null);
                                        setSelectedPayor(null);
                                        setSearchTerm('');
                                    }}
                                    className={`whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm ${
                                        activeTab === 'insurance'
                                            ? 'border-blue-500 text-blue-600'
                                            : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                    }`}
                                >
                                    Insurance Portal ({payors.length})
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>

                {/* Main Content */}
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    {/* Search Bar */}
                    <div className="mb-6">
                        <div className="relative">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <Icon type="search" />
                            </div>
                            <input
                                type="text"
                                className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder={activeTab === 'entities' ? 
                                    "Search entities by name, address, or type..." : 
                                    "Search payors by name or type..."
                                }
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </div>

                    {/* Content based on active tab */}
                    {activeTab === 'entities' ? (
                        // Entity display code
                        loading ? (
                            <div className="text-center py-10">
                                <p className="text-gray-500">Loading entities...</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="md:col-span-1 space-y-6">
                                    {Object.entries(groupedEntities).length > 0 ? (
                                        Object.entries(groupedEntities).map(([type, typeEntities]) => (
                                            <div key={type} className="bg-white rounded-lg shadow-sm overflow-hidden">
                                                <div className="bg-gray-50 px-4 py-3 border-b">
                                                    <h2 className="text-lg font-medium text-gray-900 capitalize">
                                                        {type.replace('_', ' ')}s ({typeEntities.length})
                                                    </h2>
                                                </div>
                                                <ul className="divide-y divide-gray-200">
                                                    {typeEntities.map(entity => (
                                                        <li
                                                            key={entity.id}
                                                            className={`px-4 py-3 cursor-pointer hover:bg-gray-50 entity-card ${selectedEntity && selectedEntity.id === entity.id ? 'bg-blue-50' : ''}`}
                                                            onClick={() => setSelectedEntity(entity)}
                                                        >
                                                            <div className="flex justify-between items-center">
                                                                <div onClick={() => console.log('Entity data:', entity)}>
                                                                    <h3 className="text-sm font-medium text-gray-900">{entity.name}</h3>
                                                                    {entity.address && (
                                                                        <p className="text-xs text-gray-500 flex items-center mt-1">
                                                                            <Icon type="map" className="mr-1" />
                                                                            {entity.address}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                {isAdminAuthenticated && (
                                                                    <div className="flex space-x-1">
                                                                        <button
                                                                            className="p-1 text-blue-600 hover:text-blue-800 transition-colors"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleEditEntity(entity);
                                                                            }}
                                                                        >
                                                                            <Icon type="edit" />
                                                                        </button>
                                                                        <button
                                                                            className="p-1 text-red-600 hover:text-red-800 transition-colors"
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                handleDeleteEntity(entity.id);
                                                                            }}
                                                                        >
                                                                            <Icon type="trash" />
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="bg-white rounded-lg shadow-sm p-6 text-center">
                                            <p className="text-gray-500">No entities found matching your search.</p>
                                        </div>
                                    )}
                                </div>

                                <div className="md:col-span-2">
                                    {selectedEntity ? (
                                        <div className="bg-white rounded-lg shadow-sm">
                                            <div className="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                                                <h2 className="text-xl font-bold text-gray-900">{selectedEntity.name}</h2>
                                                {console.log('Selected entity for view:', selectedEntity)}
                                                <div className="flex space-x-2">
                                                    {isAdminAuthenticated && (
                                                        <>
                                                            <button
                                                                className="px-3 py-1.5 bg-blue-100 text-blue-600 rounded-md flex items-center hover:bg-blue-200 transition-colors"
                                                                onClick={() => handleEditEntity(selectedEntity)}
                                                            >
                                                                <Icon type="edit" className="mr-1" /> Edit
                                                            </button>
                                                            <button
                                                                className="px-3 py-1.5 bg-red-100 text-red-600 rounded-md flex items-center hover:bg-red-200 transition-colors"
                                                                onClick={() => handleDeleteEntity(selectedEntity.id)}
                                                            >
                                                                <Icon type="trash" className="mr-1" /> Delete
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="p-6">
                                                {/* Entity detail display remains the same */}
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    {/* Basic Information */}
                                                    <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                        <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                            <Icon type={
                                                                selectedEntity.type === 'hospital' ? 'building' : 
                                                                selectedEntity.type === 'fire_station' ? 'alert' : 
                                                                selectedEntity.type === '911_center' ? 'dispatch' : 
                                                                'users'
                                                            } className="mr-2" />
                                                            Basic Information
                                                        </h3>
                                                        <div className="space-y-3">
                                                            <div className="flex items-start">
                                                                <div className="w-8 flex-shrink-0 flex justify-center">
                                                                    <Icon type="building" />
                                                                </div>
                                                                <div>
                                                                    <p className="text-sm text-gray-500">Type</p>
                                                                    <p className="text-gray-900 capitalize">{selectedEntity.type.replace('_', ' ')}</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-start">
                                                                <div className="w-8 flex-shrink-0 flex justify-center">
                                                                    <Icon type="map" />
                                                                </div>
                                                                <div>
                                                                    <p className="text-sm text-gray-500">Address</p>
                                                                    <p className="text-gray-900">{selectedEntity.address || 'Not specified'}</p>
                                                                </div>
                                                            </div>
                                                            <div className="flex items-start">
                                                                <div className="w-8 flex-shrink-0 flex justify-center">
                                                                    <Icon type="calendar" />
                                                                </div>
                                                                <div>
                                                                    <p className="text-sm text-gray-500">Last Contact</p>
                                                                    <p className="text-gray-900">{selectedEntity.lastContact || 'Not recorded'}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* Phone Numbers */}
                                                    {selectedEntity.phoneNumbers && selectedEntity.phoneNumbers.length > 0 && (
                                                        <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                            <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                                <Icon type="phone" className="mr-2" />
                                                                Contact Information
                                                            </h3>
                                                            <div className="space-y-4">
                                                                {selectedEntity.phoneNumbers.map((phone, index) => (
                                                                    <div key={index} className="bg-white p-3 rounded-md shadow-sm">
                                                                        <div className="flex justify-between items-center mb-1">
                                                                            <span className="font-medium text-gray-900">{phone.label || 'Unlabeled'}</span>
                                                                            <span className="font-mono text-blue-600">{phone.number}</span>
                                                                        </div>
                                                                        {phone.description && (
                                                                            <p className="text-sm text-gray-600">{phone.description}</p>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Contracted Service */}
                                                    {selectedEntity.contractedService && (
                                                        <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                            <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                                <Icon type="truck" className="mr-2" />
                                                                Contracted Service
                                                            </h3>
                                                            <p className="text-gray-900 font-medium">{selectedEntity.contractedService}</p>
                                                            
                                                            {selectedEntity.contractualObligations && selectedEntity.contractualObligations.length > 0 && (
                                                                <div className="mt-3">
                                                                    <h4 className="text-sm font-medium text-gray-700 mb-1">Contractual Obligations</h4>
                                                                    <ul className="list-disc pl-5 space-y-1">
                                                                        {selectedEntity.contractualObligations.map((obligation, index) => (
                                                                            <li key={index} className="text-gray-700">{obligation}</li>
                                                                        ))}
                                                                    </ul>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}

                                                    {/* ER Entrance */}
                                                    {selectedEntity.type === 'hospital' && selectedEntity.erEntrance && (
                                                        <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                            <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                                <Icon type="alert" className="mr-2" />
                                                                ER Entrance
                                                            </h3>
                                                            <p className="text-gray-700 bg-yellow-50 p-3 rounded-md">{selectedEntity.erEntrance}</p>
                                                        </div>
                                                    )}

                                                    {/* Flight Program */}
                                                    <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                        <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                            <Icon type="plane" className="mr-2" />
                                                            Flight Program
                                                        </h3>
                                                        <div className="space-y-3">
                                                            <div className="flex items-center">
                                                                <div className="w-8 flex-shrink-0">
                                                                    {selectedEntity.flightProgram?.isOneCall ? (
                                                                        <div className="h-4 w-4 bg-green-500 rounded-full"></div>
                                                                    ) : (
                                                                        <div className="h-4 w-4 bg-gray-300 rounded-full"></div>
                                                                    )}
                                                                </div>
                                                                <p className="text-gray-700">One Call</p>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <div className="w-8 flex-shrink-0">
                                                                    {selectedEntity.flightProgram?.participating ? (
                                                                        <div className="h-4 w-4 bg-green-500 rounded-full"></div>
                                                                    ) : (
                                                                        <div className="h-4 w-4 bg-gray-300 rounded-full"></div>
                                                                    )}
                                                                </div>
                                                                <p className="text-gray-700">Participating</p>
                                                            </div>
                                                            <div className="flex items-center">
                                                                <div className="w-8 flex-shrink-0">
                                                                    {selectedEntity.flightProgram?.flightByGround ? (
                                                                        <div className="h-4 w-4 bg-green-500 rounded-full"></div>
                                                                    ) : (
                                                                        <div className="h-4 w-4 bg-gray-300 rounded-full"></div>
                                                                    )}
                                                                </div>
                                                                <p className="text-gray-700">Flight By Ground</p>
                                                            </div>
                                                            {selectedEntity.flightProgram?.notes && (
                                                                <div className="mt-2">
                                                                    <p className="text-sm text-gray-500">Notes</p>
                                                                    <p className="text-gray-700 bg-blue-50 p-2 rounded-md">{selectedEntity.flightProgram.notes}</p>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Landing Zones for 911 Centers */}
                                                            {selectedEntity.type === '911_center' && selectedEntity.flightProgram?.landingZones && selectedEntity.flightProgram.landingZones.length > 0 && (
                                                                <div className="mt-4">
                                                                    <h4 className="text-md font-medium text-gray-900 mb-2">Known Landing Zones</h4>
                                                                    <div className="space-y-3">
                                                                        {selectedEntity.flightProgram.landingZones.map((zone, index) => (
                                                                            <div key={index} className="bg-white p-3 rounded-md shadow-sm">
                                                                                <div className="flex items-center mb-1">
                                                                                    <Icon type="location" className="mr-2" />
                                                                                    <span className="font-medium text-gray-900">{zone.name}</span>
                                                                                </div>
                                                                                {zone.coordinates && (
                                                                                    <p className="text-sm text-gray-600 font-mono mb-1">Coordinates: {zone.coordinates}</p>
                                                                                )}
                                                                                {zone.description && (
                                                                                    <p className="text-sm text-gray-600">{zone.description}</p>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Backup Services */}
                                                    <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                        <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                            <Icon type="alert" className="mr-2" />
                                                            Backup Services
                                                        </h3>
                                                        <div className="space-y-4">
                                                            {/* Air Services */}
                                                            {selectedEntity.backupServices?.airServices && selectedEntity.backupServices.airServices.length > 0 && (
                                                                <div>
                                                                    <h4 className="text-md font-medium text-gray-900 mb-2">Air Services</h4>
                                                                    <div className="space-y-3">
                                                                        {selectedEntity.backupServices.airServices.map((service, index) => (
                                                                            <div key={index} className="bg-white p-3 rounded-md shadow-sm">
                                                                                <div className="flex justify-between items-center mb-1">
                                                                                    <span className="font-medium text-gray-900">{service.name}</span>
                                                                                    {service.phone && (
                                                                                        <span className="font-mono text-blue-600">{service.phone}</span>
                                                                                    )}
                                                                                </div>
                                                                                {service.description && (
                                                                                    <p className="text-sm text-gray-600">{service.description}</p>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {/* Ground Services */}
                                                            {selectedEntity.backupServices?.groundServices && selectedEntity.backupServices.groundServices.length > 0 && (
                                                                <div>
                                                                    <h4 className="text-md font-medium text-gray-900 mb-2">Ground Services</h4>
                                                                    <div className="space-y-3">
                                                                        {selectedEntity.backupServices.groundServices.map((service, index) => (
                                                                            <div key={index} className="bg-white p-3 rounded-md shadow-sm">
                                                                                <div className="flex justify-between items-center mb-1">
                                                                                    <span className="font-medium text-gray-900">{service.name}</span>
                                                                                    {service.phone && (
                                                                                        <span className="font-mono text-blue-600">{service.phone}</span>
                                                                                    )}
                                                                                </div>
                                                                                {service.description && (
                                                                                    <p className="text-sm text-gray-600">{service.description}</p>
                                                                                )}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            
                                                            {selectedEntity.backupServices?.noUnitsContact && (
                                                                <div>
                                                                    <h4 className="text-sm font-medium text-gray-700 mb-1">No Units Contact Protocol</h4>
                                                                    <p className="text-gray-700 bg-red-50 p-3 rounded-md font-medium">{selectedEntity.backupServices.noUnitsContact}</p>
                                                                </div>
                                                            )}
                                                            
                                                            {selectedEntity.backupServices?.mutualAid && (
                                                                <div>
                                                                    <h4 className="text-sm font-medium text-gray-700 mb-1">Mutual Aid Agreements</h4>
                                                                    <p className="text-gray-700 bg-yellow-50 p-3 rounded-md font-medium">{selectedEntity.backupServices.mutualAid}</p>
                                                                </div>
                                                            )}
                                                            
                                                            {!selectedEntity.backupServices?.airServices?.length && 
                                                             !selectedEntity.backupServices?.groundServices?.length && 
                                                             !selectedEntity.backupServices?.noUnitsContact && 
                                                             !selectedEntity.backupServices?.mutualAid && (
                                                                <p className="text-gray-500 italic">No backup services specified</p>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* County Information */}
                                                    <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                                                        <h3 className="font-medium text-gray-900 mb-3 flex items-center text-lg border-b pb-2">
                                                            <Icon type="map" className="mr-2" />
                                                            County Information
                                                        </h3>
                                                        
                                                        {selectedEntity.countyInfo?.county && (
                                                            <div className="mb-4">
                                                                <p className="text-sm text-gray-500">County</p>
                                                                <p className="font-medium text-gray-900">{selectedEntity.countyInfo.county}</p>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Sheriff Agencies */}
                                                        {selectedEntity.countyInfo?.sheriffAgencies && selectedEntity.countyInfo.sheriffAgencies.length > 0 && (
                                                            <div className="mb-4">
                                                                <h4 className="text-md font-medium text-gray-900 mb-2">Sheriff Agencies</h4>
                                                                <div className="space-y-3">
                                                                    {selectedEntity.countyInfo.sheriffAgencies.map((agency, index) => (
                                                                        <div key={index} className="bg-white p-3 rounded-md shadow-sm">
                                                                            <div className="flex justify-between items-center mb-1">
                                                                                <span className="font-medium text-gray-900">{agency.name}</span>
                                                                                {agency.phone && (
                                                                                    <span className="font-mono text-blue-600">{agency.phone}</span>
                                                                                )}
                                                                            </div>
                                                                            {agency.description && (
                                                                                <p className="text-sm text-gray-600">{agency.description}</p>
                                                                            )}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Fire Agencies */}
                                                        {selectedEntity.countyInfo?.fireAgencies && selectedEntity.countyInfo.fireAgencies.length > 0 && (
                                                            <div className="mb-4">
                                                                <h4 className="text-md font-medium text-gray-900 mb-2">Fire Agencies</h4>
                                                                <div className="space-y-3">
                                                                    {selectedEntity.countyInfo.fireAgencies.map((agency, index) => (
                                                                        <div key={index} className="bg-white p-
