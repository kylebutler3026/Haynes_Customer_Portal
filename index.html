// Entity management functions
        const handleSaveNewEntity = async (formData) => {
            try {
                console.log('Saving entity with formData:', formData);
                
                const today = new Date().toISOString().split('T')[0];
                
                // Clean and validate phone numbers
                const cleanedPhoneNumbers = (formData.phone_numbers || [])
                    .filter(phone => phone && phone.number && phone.number.trim() !== '')
                    .map(phone => ({
                        label: phone.label || '',
                        number: phone.number || '',
                        description: phone.description || ''
                    }));

                // Clean contractual obligations
                const cleanedObligations = (formData.contractual_obligations || [])
                    .filter(obligation => obligation && obligation.trim() !== '');

                const entityToSave = {
                    name: formData.name || '',
                    type: formData.type || 'hospital',
                    address: formData.address || '',
                    phone_numbers: cleanedPhoneNumbers.length > 0 ? cleanedPhoneNumbers : [],
                    contracted_service: formData.contracted_service || '',
                    contractual_obligations: cleanedObligations,
                    er_entrance: formData.er_entrance || '',
                    flight_program: {
                        isOneCall: formData.flight_program?.isOneCall || false,
                        participating: formData.flight_program?.participating || false,
                        flightByGround: formData.flight_program?.flightByGround || false,
                        notes: formData.flight_program?.notes || '',
                        landingZones: (formData.flight_program?.landingZones || [])
                            .filter(zone => zone && zone.name && zone.name.trim() !== '')
                            .map(zone => ({
                                name: zone.name || '',
                                coordinates: zone.coordinates || '',
                                description: zone.description || ''
                            }))
                    },
                    backup_services: {
                        airServices: (formData.backup_services?.airServices || [])
                            .filter(service => service && service.name && service.name.trim() !== '')
                            .map(service => ({
                                name: service.name || '',
                                phone: service.phone || '',
                                description: service.description || ''
                            })),
                        groundServices: (formData.backup_services?.groundServices || [])
                            .filter(service => service && service.name && service.name.trim() !== '')
                            .map(service => ({
                                name: service.name || '',
                                phone: service.phone || '',
                                description: service.description || ''
                            })),
                        noUnitsContact: formData.backup_services?.noUnitsContact || '',
                        mutualAid: formData.backup_services?.mutualAid || ''
                    },
                    county_info: {
                        county: formData.county_info?.county || '',
                        sheriffAgencies: (formData.county_info?.sheriffAgencies || [])
                            .filter(agency => agency && agency.name && agency.name.trim() !== '')
                            .map(agency => ({
                                name: agency.name || '',
                                phone: agency.phone || '',
                                description: agency.description || ''
                            })),
                        fireAgencies: (formData.county_info?.fireAgencies || [])
                            .filter(agency => agency && agency.name && agency.name.trim() !== '')
                            .map(agency => ({
                                name: agency.name || '',
                                phone: agency.phone || '',
                                description: agency.description || ''
                            })),
                        emsAgencies: (formData.county_info?.emsAgencies || [])
                            .filter(agency => agency && agency.name && agency.name.trim() !== '')
                            .map(agency => ({
                                name: agency.name || '',
                                phone: agency.phone || '',
                                description: agency.description || ''
                            }))
                    },
                    notes: formData.notes || '',
                    last_contact: formData.last_contact || today
                };

                console.log('Cleaned entity to save:', entityToSave);

                if (formData.id) {
                    const { data, error } = await supabase
                        .from('emergency_entities')
                        .update(entityToSave)
                        .eq('id', formData.id)
                        .select();

                    if (error) {
                        console.error('Error updating entity:', error);
                        alert(`Error updating entity: ${error.message}`);
                        return;
                    }
                    console.log('Entity updated successfully:', data);
                    setEntityToEdit(null);
                } else {
                    const { data, error } = await supabase
                        .from('emergency_entities')
                        .insert([entityToSave])
                        .select();

                    if (error) {
                        console.error('Error saving entity:', error);
                        alert(`Error saving entity: ${error.message}`);
                        return;
                    }
                    console.log('Entity created successfully:', data);
                }

                setShowAdmin(false);
                await loadEntities(); // Refresh the list
            } catch (err) {
                console.error('Error saving entity:', err);
                alert(`Error saving entity: ${err.message}`);
            }
        };
